sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/m/Page","sap/m/Panel","sap/m/CheckBox","sap/m/Text","sap/ui/core/UIComponent","sap/m/MessagePopover","sap/m/MessageItem","sap/ui/core/message/Message","sap/ui/core/MessageType","sap/ui/core/message/MessageManager","sap/ui/core/Fragment"],function(e,t,s,a,r,i,o,n,l,c,d,g,u,p){"use strict";var h=[],m,f;return e.extend("cmmregistration.controller.Registration",{onInit:function(){var e=new Date;e.setHours(0,0,0,0);var s=e.toISOString().split("T")[0];f=new Intl.DateTimeFormat("en-US",{dateStyle:"medium"}).format(new Date);this.getView().setModel(new t({here:"If you already have an Enerline account, Please sign in "+'<a target="_blank" href="https://www.enbridgegas.com/storage-transportation/enerline/direct-connect"><u>here</u></a>'}));this.allUsersAccessRights={};var a=new t({isItemSelected:false,alluserAccess:false,selectedUser:null,issubscribersSelected:false,isAnyAccessSelected:true,isSubmitbtn:false,currentDate:s,requestType:"",firstName:"",lastName:"",phone:"",email:"",employerName:"",employerAddress:"",selectedAuthSign:"",accessRequest:"",jobTitle:"",allAcessRights:"",otherFormData:{},isStep2Valid:false,subscribers:[],accessType:[]});this.getView().setModel(a,"wizardModel");var r=new sap.ui.model.json.JSONModel({users:[]});this.getView().setModel(r,"AccessModel");var i=this.getView();this.oMessageManager=sap.ui.getCore().getMessageManager();i.setModel(this.oMessageManager.getMessageModel(),"message");this.oMessageManager.registerObject(i,true);this.oMessagePopover=new sap.m.MessagePopover({items:{path:"message>/",template:new sap.m.MessageItem({title:"{message>message}",type:"{message>type}",description:"{message>description}",icon:"{message>icon}",counter:"{message>counter}"})}});i.addDependent(this.oMessagePopover);this.fetchCategoriesAndRights()},loadRecaptcha:function(){var e=this;if(typeof grecaptcha==="undefined"){console.log("Loading reCAPTCHA API...");var t=document.createElement("script");t.src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoad&render=explicit";t.async=true;t.defer=true;document.head.appendChild(t);window.onRecaptchaLoad=function(){console.log("reCAPTCHA API Loaded");e.renderRecaptcha()}}else{console.log("reCAPTCHA already loaded");this.renderRecaptcha()}},renderRecaptcha:function(){console.log("Checking reCAPTCHA div:",document.getElementById("recaptchaGoogle"));setTimeout(()=>{var e=document.getElementById("recaptchaGoogle");if(e&&typeof grecaptcha!=="undefined"){console.log("Rendering reCAPTCHA...");grecaptcha.render("recaptchaGoogle",{sitekey:"6LfaKP8qAAAAAC6ivR0QAFzlnJwj_lKRc-gUxw2a",callback:this.verifyCallback.bind(this),"expired-callback":this.expiredCallback.bind(this)})}else{console.error("reCAPTCHA div not found!")}},1e3)},expiredCallback:function(){console.log("reCAPTCHA expired!");var e=this.getView().getModel("wizardModel");e.setProperty("/isSubmitbtn",false);sap.m.MessageToast.show("verify captca again")},verifyCallback:function(e){const t=this;console.log("CAPTCHA Verified! Token:",e);if(e){const s={token:e};const a=this.getOwnerComponent().getModel();a.create("/googleapi",s,{success:function(e){var s=t.getView().getModel("wizardModel");s.setProperty("/isSubmitbtn",true)},error:function(e){sap.m.MessageToast.show("Error in submission")}})}},onReadAddress:function(){const e=this.getOwnerComponent().getModel();e.read("/getAddress",{success:e=>{var s=new t;const a=e.getAddress.value;s.setData({value:a});this.getView().setModel(s,"addressModel")},error:()=>{sap.m.MessageToast.show("Error in submission")}})},fetchCategoriesAndRights:function(){const e=this;const t=this.getOwnerComponent().getModel();t.read("/accessrighttype",{success:s=>{const a=s.results||[];console.log("📌 Fetched Categories:",a);a.sort((e,t)=>e.categoryName.localeCompare(t.categoryName));t.read("/accessrights",{success:t=>{const s=t.results||[];console.log("📌 Fetched Access Rights:",s);const r=a.map(e=>({categoryID:e.ID,categoryName:e.categoryName,accessRights:s.filter(t=>t.category_ID===e.ID).map(e=>({accessTypeID:e.ID,rightName:e.rightName}))}));var i=e.getView().getModel("wizardModel");i.setProperty("/allAcessRights",r);console.log("✅ Grouped Access Rights with IDs:",JSON.stringify(r,null,2))},error:e=>console.error("❌ Error fetching access rights:",e)})},error:e=>console.error("❌ Error fetching categories:",e)})},onSuggest:function(e){var t=e.getParameter("suggestValue").toLowerCase();var s=e.getSource();var a=this.getView().getModel("addressModel");var r=a.getData().value;var i=r.filter(function(e){return e.street.toLowerCase().includes(t)||e.municipality.toLowerCase().includes(t)||e.province.toLowerCase().includes(t)});var o=new sap.ui.model.json.JSONModel;o.setData({value:i});s.setModel(o);s.openSuggestionPopup()},onPrevious:function(){var e=this.byId("idCreateProductWizard");if(e){var t=e.getProgress();if(t>1){e.previousStep()}}},onNavigate:function(e){var t=e.getSource().data("direction");var s=this.byId("idCreateProductWizard");if(!s)return;var a=s.mAggregations._progressNavigator.getCurrentStep();var r=parseInt(e.getSource().data("targetStep"),10);if(Math.abs(a-r)>1){this.resetWizardState()}if(t==="next"){this.onProceed()}else if(t==="prev"){if(m==="X"&&a===5){this.getView().byId("idCreateProductWizard").mAggregations._progressNavigator._moveToStep(4);s.goToStep(this.getView().byId("PricingStep"))}else if(m==="X"&&a===2){this.getView().byId("idCreateProductWizard").mAggregations._progressNavigator._moveToStep(1);s.goToStep(this.getView().byId("idAccessType"))}else if(m==="X"&&a===3){this.getView().byId("idCreateProductWizard").mAggregations._progressNavigator._moveToStep(2);s.goToStep(this.getView().byId("idCompanyInfo"))}else if(m==="X"&&a===4){this.getView().byId("idCreateProductWizard").mAggregations._progressNavigator._moveToStep(3);s.goToStep(this.getView().byId("idSubscriberInfo"))}else{s.previousStep()}}},resetWizardState:function(){var e=this.byId("idCreateProductWizard");if(!e)return;e.discardProgress(e.getSteps()[0]);this.recaptchaLoaded=false;this.oMessageManager.removeAllMessages()},onSelectionChange:function(e){var t=this.getView().getModel("wizardModel");var s=e.getParameter("listItem");if(s){var a=s.getAggregation("content")[0];var r=a.getAggregation("items")[0];if(r&&r.isA("sap.m.Title")){var i=r.getText();t.setProperty("/accessRequest",i);t.setProperty("/isItemSelected",true)}}},onProceed:function(){var e=this.byId("idCreateProductWizard");if(!e)return;var t=e.mAggregations._progressNavigator.getCurrentStep();var s=this.getView().getModel("wizardModel");this.oMessageManager.removeAllMessages();if(t===2&&m!="X"){this.getView().byId("idAccessType").setIcon("sap-icon://accept");if(!this.validateSecondStep()){if(!this.oMessagePopover.isOpen()){this.oMessagePopover.openBy(this.getView().byId("messagePopoverButton"))}return}var a=s.getProperty("/subscribers")||[];var r={firstName:s.getProperty("/firstName"),lastName:s.getProperty("/lastName"),jobTitle:s.getProperty("/jobTitle"),email:s.getProperty("/email"),phone:s.getProperty("/phone"),requestEffDate:new Intl.DateTimeFormat("en-US",{dateStyle:"medium"}).format(new Date)};var i=a.some(e=>e.email===r.email);if(!i){a.push(r);s.setProperty("/subscribers",a)}e.nextStep()}else if(t===3&&m!="X"){if(!this.validateSubscribers()){if(!this.oMessagePopover.isOpen()){this.oMessagePopover.openBy(this.getView().byId("messagePopoverButton"))}return}this.onPressNavToDetail();e.nextStep()}else if(t===4&&m!="X"){var o=this.getView().byId("userLists"),n=o.getItems()[0];o.setSelectedItem(n,true,true);if(!this.recaptchaLoaded){this.recaptchaLoaded=true;this.loadRecaptcha()}this.getView().byId("_IDGenButton3").setVisible(true);e.nextStep()}else{if(m==="X"&&t===1){this.getView().byId("idCreateProductWizard").mAggregations._progressNavigator._moveToStep(2);e.goToStep(this.getView().byId("idCompanyInfo"))}else if(m==="X"&&t===2){this.getView().byId("idCreateProductWizard").mAggregations._progressNavigator._moveToStep(3);e.goToStep(this.getView().byId("idSubscriberInfo"))}else if(m==="X"&&t===3){this.getView().byId("idCreateProductWizard").mAggregations._progressNavigator._moveToStep(4);e.goToStep(this.getView().byId("PricingStep"))}else if(m==="X"&&t===4){this.getView().byId("_IDGenButton3").setVisible(true);this.getView().byId("idCreateProductWizard").mAggregations._progressNavigator._moveToStep(5);e.goToStep(this.getView().byId("ReviewPage"))}else{e.nextStep()}}},validateSubscribers:function(e){var t=this.getView();var s=t.getModel("wizardModel");var a=true;this.oMessageManager.removeAllMessages();var r=/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;var i=/^\d{10}(x\d+)?$/;var o=s.getProperty("/subscribers")||[];var n=t.byId("idTableAddOper").getItems();var l=function(e,t,s,r,i,o){var l=n[e].getCells()[t];if(s){a=false;this.addMessage(`Subscriber ${e+1}: ${r}`,o,i);l.setValueState("Error");l.setValueStateText(r)}else{l.setValueState("None")}}.bind(this);o.forEach(function(t,s){if(e){var a=e.getParameter("id").split("--").pop();var o=e.getParameter("value");switch(a){case"firstName":l(s,0,!o||o.length>100,"First Name required (max 100 chars).","sap-icon://alert",sap.ui.core.MessageType.Error);break;case"lastName":l(s,1,!o||o.length>100,"Last Name required (max 100 chars).","sap-icon://alert",sap.ui.core.MessageType.Error);break;case"jobTitle":l(s,2,!o||o.length>150,"Job Title required (max 150 chars).","sap-icon://alert",sap.ui.core.MessageType.Error);break;case"email":l(s,3,!r.test(o)||o.length>150,"Invalid Email (max 150 chars).","sap-icon://email",sap.ui.core.MessageType.Warning);break;case"phone":l(s,4,!i.test(o),"Phone must be exactly 10 digits.","sap-icon://phone",sap.ui.core.MessageType.Warning);break;case"requestEffDate":var n=e.getParameter("value");if(!n){l(s,5,true,"Request Effective Date is required.","sap-icon://calendar",sap.ui.core.MessageType.Error)}else{l(s,5,false,"","","")}break}}else{l(s,0,!t.firstName||t.firstName.length>100,"First Name required (max 100 chars).","sap-icon://alert",sap.ui.core.MessageType.Error);l(s,1,!t.lastName||t.lastName.length>100,"Last Name required (max 100 chars).","sap-icon://alert",sap.ui.core.MessageType.Error);l(s,2,!t.jobTitle||t.jobTitle.length>150,"Job Title required (max 150 chars).","sap-icon://alert",sap.ui.core.MessageType.Error);l(s,3,!r.test(t.email)||t.email.length>150,"Invalid Email (max 150 chars).","sap-icon://email",sap.ui.core.MessageType.Error);l(s,4,!i.test(t.phone),"Phone must be exactly 10 digits.","sap-icon://phone",sap.ui.core.MessageType.Error);l(s,5,!t.requestEffDate,"Request Effective Date is required.","sap-icon://calendar",sap.ui.core.MessageType.Error)}});return a},onMessagePopoverPress:function(e){this.oMessagePopover.toggle(e.getSource())},validateAndProceed:function(e){var t=this.validateSecondStep();if(t){this.getView().byId("idCreateProductWizard").nextStep()}else{this.oMessagePopover.openBy(this.getView().byId("messagePopoverButton"))}},validateSecondStep:function(){var e=this.getView(),t=0;var s=e.getModel("wizardModel");var a=true;this.oMessageManager.removeAllMessages();var r=/^[A-Za-z\s]+$/;var i=/^\d{10}(x\d+)?$/;var o=/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;var n={"Required Fields":"sap-icon://alert","Invalid Format":"sap-icon://error","Dropdown Selection":"sap-icon://form"};var l=[{id:"idTypeOfRequest",key:"requestType",label:"Type of Request",type:"dropdown",category:"Dropdown Selection"},{id:"idFirst",key:"firstName",label:"First Name",regex:r,category:"Required Fields"},{id:"idLast",key:"lastName",label:"Last Name",regex:r,category:"Required Fields"},{id:"idPhone",key:"phone",label:"Phone Number",regex:i,category:"Invalid Format"},{id:"idEmailAddress",key:"email",label:"Email Address",regex:o,category:"Invalid Format"},{id:"idEmpName",key:"employerName",label:"Employer Name",regex:r,category:"Required Fields"},{id:"idEmpAdd",key:"employerAddress",label:"Employer Address",category:"Required Fields"},{id:"idempjobTitle",key:"jobTitle",label:"Job Title",category:"Required Fields"},{id:"idAuthSign",key:"selectedAuthSign",label:"Authorized Signatory",type:"dropdown",category:"Dropdown Selection"}];if(s.getProperty("/selectedAuthSign")==="Other"){l.push({id:"idFirstOther",key:"otherFirstName",label:"Other First Name",regex:r,category:"Required Fields"},{id:"idLastOther",key:"otherLastName",label:"Other Last Name",regex:r,category:"Required Fields"},{id:"idPhoneOther",key:"otherPhone",label:"Other Phone Number",regex:i,category:"Invalid Format"},{id:"idEmailOther",key:"otherEmail",label:"Other Email Address",regex:o,category:"Invalid Format"},{id:"idJobTitle",key:"jobTitle",label:"Job Title",regex:r,category:"Required Fields"})}var c=function(t,s,r,i,o,n){var l=e.byId(t.id);if(r){a=false;this.addMessage(i,n,o);l.setValueState("Error");l.setValueStateText(i)}else{l.setValueState("None")}}.bind(this);l.forEach(function(e){var a=s.getProperty("/"+e.key)?.trim();if(!a){c(e,a,true,`${e.label} is required.`,"sap-icon://alert",sap.ui.core.MessageType.Error)}else if(e.regex&&!e.regex.test(a)){t+=1;c(e,a,true,`Invalid ${e.label}.`,"sap-icon://error",sap.ui.core.MessageType.Error)}else{c(e,a,false)}});if(!a){this.oMessagePopover.openBy(this.getView().byId("messagePopoverButton"))}return a},addMessage:function(e,t,s){var a=new sap.ui.core.message.ControlMessageProcessor;var r=new sap.ui.core.message.Message({message:e,type:t,description:e,icon:s,processor:a});this.oMessageManager.addMessages(r);console.log(this.oMessageManager.getMessageModel().getData())},onInputLiveChange:function(e){var t=e.getSource();var s=t.getValue().trim();var a=t.getId();var r=this.getView().getModel("wizardModel");var i={idFirst:/^[A-Za-z\s]+$/,idLast:/^[A-Za-z\s]+$/,idEmailAddress:/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/,idEmpName:/^[A-Za-z\s]+$/,idFirstOther:/^[A-Za-z\s]+$/,idLastOther:/^[A-Za-z\s]+$/,idempjobTitle:/^[A-Za-z\s]+$/,idEmailOther:/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/,idJobTitle:/^[A-Za-z\s]+$/,idEmpTitle:/^[A-Za-z\s]+$/};var o=i[a];if(!s){t.setValueState("Error");t.setValueStateText("This field is required.")}else if(o&&!o.test(s)){t.setValueState("Error");t.setValueStateText("Invalid input.")}else{t.setValueState("None");this.getView().byId("btnNextm").setVisible(true)}var n=Object.keys(i).find(e=>e===a);if(n){r.setProperty("/"+n.replace("id","").toLowerCase(),s)}},onLiveChangeSubscribers:function(e){var t=e.getSource();var s=t.getValue().trim();var a=t.getId().split("--").pop();var r=this.getView().getModel("wizardModel");var i=new Date;i.setHours(0,0,0,0);var o={idFirstSub:{regex:/^[A-Za-z\s]+$/,maxLength:100,errorText:"Only alphabets allowed, max 100 chars."},idLastSub:{regex:/^[A-Za-z\s]+$/,maxLength:100,errorText:"Only alphabets allowed, max 100 chars."},idEmailSub:{regex:/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/,maxLength:150,errorText:"Invalid email format, max 150 chars."},idJobTitleSub:{regex:/^[A-Za-z\s]+$/,maxLength:150,errorText:"Only alphabets allowed, max 150 chars."}};var n=o[a];if(!s){t.setValueState("Error");t.setValueStateText("This field is required.")}else if(n&&(s.length>n.maxLength||!n.regex.test(s))){t.setValueState("Error");t.setValueStateText(n.errorText)}else if(a==="idRequestEffDate"){var l=new Date(s);l.setHours(0,0,0,0);if(!s){t.setValueState("Error");t.setValueStateText("Effective Date is required.")}else if(l<i){t.setValueState("Error");t.setValueStateText("Effective Date cannot be in the past.")}else{t.setValueState("None")}}else{t.setValueState("None")}var c=this.checkAllSubscribersValid()},checkAllSubscribersValid:function(){var e=this.getView();var t=["idFirstSub","idLastSub","idPhoneSub","idEmailSub","idJobTitleSub","idRequestEffDate"];for(var s=0;s<t.length;s++){var a=e.byId(t[s]);if(a&&a.getValueState()==="Error"){return false}}return true},isDuplicateEmail:function(e,t,s){return e.some((e,a)=>a!==s&&e.email===t)},onFieldSearch:function(e){var t=e.getParameter("query")||e.getParameter("newValue");var s=this.byId("idTableAddOper");var a=s.getBinding("items");if(a){var r=[];if(t){var i=new sap.ui.model.Filter("firstName",sap.ui.model.FilterOperator.Contains,t);var o=new sap.ui.model.Filter("lastName",sap.ui.model.FilterOperator.Contains,t);var n=new sap.ui.model.Filter("jobTitle",sap.ui.model.FilterOperator.Contains,t);var l=new sap.ui.model.Filter("email",sap.ui.model.FilterOperator.Contains,t);var c=new sap.ui.model.Filter("phone",sap.ui.model.FilterOperator.Contains,t);var d=new sap.ui.model.Filter({filters:[i,o,n,l,c],and:false});r.push(d)}a.filter(r)}},onAddItem:function(){var e=this.getView().getModel("wizardModel");var t=e.getProperty("/subscribers")||[];var s={firstName:"",lastName:"",jobTitle:"",email:"",phone:"",requestEffDate:new Intl.DateTimeFormat("en-US",{dateStyle:"medium"}).format(new Date),valid:false,isEditable:true,isNameEditable:true};t.unshift(s);e.setProperty("/subscribers",t);e.refresh(true)},onDeleteSubscriber:function(e){var t=this.getView().getModel("wizardModel");var s=e.getSource();var a=s.getParent();var r=a.getBindingContext("wizardModel");var i=r.getPath();var o=parseInt(i.split("/").pop());var n=t.getProperty("/subscribers")||[];if(n.length<=1){MessageToast.show("At least one subscriber is required.");return}n.splice(o,1);t.setProperty("/subscribers",n)},onRequestDateChange:function(e){var t=e.getSource();var s=new Date;s.setHours(0,0,0,0);t.setMinDate(s);var a=t.getDateValue();if(a&&a<s){sap.m.MessageToast.show("You cannot select a past date.");t.setDateValue(s)}},onSubscriberSelection:function(e){var t=this.getView().getModel("wizardModel");var s=e.getSource().getSelectedItems();var a=s.length>0;t.setProperty("/issubscribersSelected",a);s.forEach(function(e){var t=e.getBindingContext("wizardModel");var s=t.getObject();if(s.firstName&&s.lastName){s.isNameEditable=false}});t.refresh(true)},handleNextButton:function(){var e=this.getView().getModel("wizardModel");var t=this.getView().findAggregatedObjects(true,function(e){return e.isA("sap.m.CheckBox")});var s=t.some(function(e){return e.getSelected()});e.setProperty("/isStep2Valid",s)},isAnyCheckboxSelected:function(){var e=this.getView();var t=e.findAggregatedObjects(true,function(e){return e.isA("sap.m.CheckBox")});return t.some(function(e){return e.getSelected()})},onNavigateToTopHeader:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("TargetTopHeader",{TopHeader:"default"})},handleNextButtonAR:function(e){var t=this.getView().getModel("wizardModel");var s=t.getProperty("/accessType")||[];var a=e.getSource();var r=a.getText();var i=a.getSelected();if(i){if(!s.includes(r)){s.push(r)}}else{s=s.filter(e=>e!==r)}t.setProperty("/accessType",s);console.log("Selected Access Types:",s)},handleGoToAccessRights:function(e){this.getView().byId("_IDGenButton3").setVisible(false);m="X";this.getView().byId("idCreateProductWizard").mAggregations._progressNavigator._moveToStep(4);this.getView().byId("idCreateProductWizard").goToStep(this.getView().byId("PricingStep"),true)},handleGoToSubscriber:function(e){this.getView().byId("_IDGenButton3").setVisible(false);m="X";this.getView().byId("idCreateProductWizard").mAggregations._progressNavigator._moveToStep(3);this.getView().byId("idCreateProductWizard").goToStep(this.getView().byId("idSubscriberInfo"),true)},handleGoToCompanyInfo:function(e){this.getView().byId("_IDGenButton3").setVisible(false);m="X";this.getView().byId("idCreateProductWizard").mAggregations._progressNavigator._moveToStep(2);this.getView().byId("idCreateProductWizard").goToStep(this.getView().byId("idCompanyInfo"),true)},handleGoToAccessType:function(e){this.getView().byId("_IDGenButton3").setVisible(false);m="X";this.getView().byId("idCreateProductWizard").mAggregations._progressNavigator._moveToStep(1);this.getView().byId("idCreateProductWizard").goToStep(this.getView().byId("idAccessType"),true)},handleNextButton:function(e){this},onPressNavToDetail:function(e){var t=e?e.getSource():null;var s=this.getView().getModel("wizardModel");var a=s.getProperty("/subscribers");var r=s.getProperty("/allAcessRights");var i=null;if(t){var o=t.getBindingContext("wizardModel");if(o){i=o.getObject()}}if(!i&&Array.isArray(a)&&a.length>0){i=a[0]}if(a.length>1){s.setProperty("/alluserAccess",true)}if(i){this.selectedUser=i;var n="detailPage_"+Math.floor(Math.random()*1e5);var l=this.byId("SplitAppDemo");var c=[];if(this.getView().getModel("wizardModel").getData().requestType==="Terminate All Access"){var d=this.getView().getModel("wizardModel").getData().subscribers;var g=[];g=d;this.getView().getModel("AccessModel").setProperty("/users",g);var u=[];u.push(new sap.m.Title({text:"Effective "+f+" remove all access from the existing user."}));var p=new sap.m.Panel({expandable:false,content:u});c.push(p)}else if(this.getView().getModel("wizardModel").getData().requestType==="Terminate All Access and Terminate Employment Relationship with Company"){var d=this.getView().getModel("wizardModel").getData().subscribers;var g=[];g=d;this.getView().getModel("AccessModel").setProperty("/users",g);var u=[];u.push(new sap.m.Title({text:"Effective "+f+" remove all access rights and termination from the existing user."}));var p=new sap.m.Panel({expandable:false,content:u});c.push(p)}else{Object.keys(r).forEach(function(e){var t=r[e];var s=[];var a=this.getView().getModel("AccessModel").getProperty("/users").find(e=>e.firstName===this.selectedUser.firstName&&e.lastName===this.selectedUser.lastName);var i=a?a.accessRights[t.categoryName]:undefined;t.accessRights.forEach(function(e,a){var r=false;if(i&&i.rights){r=i.rights.find(t=>t.accessTypeID===e.accessTypeID)?true:false}s.push(new sap.m.CheckBox({text:e.rightName,select:this.onAccessRightChange.bind(this,t.categoryID,t.categoryName,e.accessTypeID,e.rightName),selected:r}));if(a!==t.accessRights.length-1){s.push(new sap.ui.core.HTML({content:"<br>"}))}}.bind(this));var o=new sap.m.Panel({headerText:t.categoryName,expandable:false,content:s});c.push(o)}.bind(this))}var h=new sap.m.Page(n,{title:"Access Rights for "+i.firstName+" "+i.lastName,content:c});l.addDetailPage(h);l.toDetail(n)}else{console.error("No valid user found in subscribers list.")}},onAccessRightChange:function(e,t,s,a,r){var i=r.getSource();var o=i.getSelected();var n=this.getView().getModel("AccessModel");var l=this.getView().getModel("wizardModel");if(!this.selectedUser){console.error("❌ No user selected.");return}var c=n.getProperty("/users")||[];var d=c.find(e=>e.firstName===this.selectedUser.firstName&&e.lastName===this.selectedUser.lastName);if(!d){d={firstName:this.selectedUser.firstName,lastName:this.selectedUser.lastName,categoryID:e,accessRights:{}};c.push(d)}if(!d.accessRights[t]){d.accessRights[t]={categoryID:e,rights:[]}}var g={accessTypeID:s,rightName:a};if(o){if(!d.accessRights[t].rights.some(e=>e.accessTypeID===s)){d.accessRights[t].rights.push(g)}}else{d.accessRights[t].rights=d.accessRights[t].rights.filter(e=>e.accessTypeID!==s)}n.setProperty("/users",c);l.setProperty("/selectedUser",d);this.updateAccessPanels()},onUserSelect:function(e){var t=e.getParameter("listItem");var s=t.getBindingContext("AccessModel");var a=this.getView().getModel("AccessModel");this.selectedUser=s.getObject();if(this.selectedUser){this.updateAccessPanels();var r=this.getView().byId("userList");r.setSelectedItem(t,true);this.getView().byId("SplitApp").toDetail(this.getView().byId("detailPage"))}else{console.warn("⚠️ No user selected.")}},updateAccessPanels:function(){var e=this.getView().byId("accessVBox");e.removeAllItems();if(!this.selectedUser){console.warn("⚠️ No user selected.");return}var t=this.createAccessPanels(this.selectedUser);e.addItem(t)},createAccessPanels:function(e){var t=[];if(this.getView().getModel("wizardModel").getData().requestType==="Terminate All Access"){var s=this.getView().getModel("wizardModel").getData().subscribers;var a=[];a=s;this.getView().getModel("AccessModel").setProperty("/users",a);var r=[];r.push(new sap.m.Title({text:"Effective "+f+" remove all access from the existing user."}));var i=new sap.m.Panel({expandable:false,content:r});t.push(i)}else if(this.getView().getModel("wizardModel").getData().requestType==="Terminate All Access and Terminate Employment Relationship with Company"){var r=[];r.push(new sap.m.Title({text:"Effective "+f+" remove all access rights and termination from the existing user."}));var i=new sap.m.Panel({expandable:false,content:r});t.push(i)}else{Object.keys(e.accessRights||{}).forEach(function(s){var a=e.accessRights[s];if(a.rights.length>0){var r=new sap.m.Panel({headerText:s,expandable:false});var i=new sap.m.List;a.rights.forEach(function(e){i.addItem(new sap.m.StandardListItem({title:e.rightName}))});r.addContent(i);t.push(r)}})}return new sap.m.VBox({items:t})},giveAccessRight:function(){var e=this.getView().getModel("wizardModel");var t=this.getView().getModel("AccessModel");var s=t.getProperty("/users")||[];if(!Array.isArray(s)||s.length===0){console.error("❌ No users with access rights found.");return}var a=s[0];if(!a||!a.accessRights){console.error("❌ No reference user with valid access rights found in AccessModel.");return}console.log("🔹 Reference User (Roles Source):",a);var r=e.getProperty("/subscribers")||[];r.forEach(function(e){var t=s.find(t=>t.firstName===e.firstName&&t.lastName===e.lastName);if(!t){t={firstName:e.firstName,lastName:e.lastName,categoryID:e.categoryID,accessRights:{}};s.push(t)}t.accessRights=JSON.parse(JSON.stringify(a.accessRights));Object.keys(t.accessRights).forEach(e=>{t.accessRights[e].categoryID=a.accessRights[e].categoryID})});console.log("✅ Updated Users List:",JSON.parse(JSON.stringify(s)));t.setProperty("/users",s);sap.m.MessageToast.show("✅ Roles (including Right IDs & Category ID) copied from the first user to all users!")},onSubmit:function(){var e=this.getView().getModel("wizardModel");var t=this.getView().getModel("AccessModel");var s=this.getOwnerComponent().getModel();var a={firstName:this.byId("idFirst").getValue(),lastName:this.byId("idLast").getValue(),phoneNumber:this.byId("idPhone").getValue(),emailID:this.byId("idEmailAddress").getValue(),empName:this.byId("idEmpName").getValue().trim(),empAddress:this.byId("idEmpAdd").getValue().trim(),authorizedSignatory:this.byId("idAuthSign").getSelectedKey(),requestType:this.byId("idTypeOfRequest").getSelectedKey(),subscribers:[],accessTypes:[]};var r=e.getProperty("/subscribers")||[];var i=t.getProperty("/users")||[];if(r.length===0){sap.m.MessageToast.show("At least one subscriber must be added.");return}a.subscribers=r.map(e=>({firstName:e.firstName||"",lastName:e.lastName||"",phone:e.phone||"",email:e.email||"",requestDate:e.requestEffDate||""}));var o={};i.forEach(e=>{Object.keys(e.accessRights||{}).forEach(t=>{var s=e.accessRights[t];if(!o[s.categoryID]){o[s.categoryID]={categoryID:s.categoryID,categoryName:t,rights:[]}}s.rights.forEach(e=>{o[s.categoryID].rights.push({rightID:e.accessTypeID,rightName:e.rightName})})})});a.accessTypes=Object.values(o);console.log("🚀 Final Payload:",JSON.parse(JSON.stringify(a)));s.create("/submitRequest",a,{success:function(){debugger;var e=`Thank you for submitting your request. This request has been <br>\n                                                sent to ${a.firstName} ${a.lastName} who has been identified as the Authorized <br>\n                                                 Signatory for approval purposes.`;new sap.m.Dialog({title:"Request received",type:"Message",state:"Success",content:[new sap.m.FormattedText({htmlText:e})],endButton:new sap.m.Button({text:"Close",press:function(e){e.getSource().getParent().close();location.reload()}.bind(this)})}).open()},error:function(e){var t="Error in submission. Please check the data.";if(e&&e.responseText){try{var s=JSON.parse(e.responseText);t=s.error?.message?.value||t}catch(e){console.error("Error parsing backend response:",e)}}sap.m.MessageToast.show(t)}})}})});
//# sourceMappingURL=Registration.controller.js.map